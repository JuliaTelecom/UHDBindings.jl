<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Custom use of LibUHD · UHDBindings.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="UHDBindings.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">UHDBindings.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Introduction to UHDBindings</a></li><li><a class="tocitem" href="../base/">Function list</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../Examples/example_setup/">Set up a Radio Link and get some samples</a></li><li><a class="tocitem" href="../Examples/example_parameters/">Update parameters of the radio</a></li><li><a class="tocitem" href="../Examples/example_benchmark/">Benchmark for Rx link</a></li></ul></li><li class="is-active"><a class="tocitem" href>Custom use of LibUHD</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Custom use of LibUHD</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Custom use of LibUHD</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaTelecom/UHDBindings.jl/blob/master/docs/src/use_libuhd.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Low-level-API"><a class="docs-heading-anchor" href="#Low-level-API">Low level API</a><a id="Low-level-API-1"></a><a class="docs-heading-anchor-permalink" href="#Low-level-API" title="Permalink"></a></h1><p>The functions provided by UHDBindings covers two aspects: the high level API (with Julia calls and structures) and the low level API, which consists of the C functions provided by UHD. The bindings, generated by Clang.jl are not directly exported by UHDBindings but the functions can be used with </p><pre><code class="nohighlight hljs">    # High level call 
    using UHDBindings
    radio = openUHD(700e6,4e6,50;nbAntennaRx=1,nbAntennaTx=1)
    # Low level call
    import UHDBindings.LibUHD as LibUHD
    LibUHD.uhd_usrp_....()</code></pre><p>In this case, it is necessary to align the parameters with the one requested by UHD. Thus </p><ul><li>To the get output parameters, it is necessary to define beforehand a Reference with the appropriate type and then deference the ref to get the value  </li><li>uhd functions often request parameters defined in the top structure layer of UHDBindings. <ul><li><code>h</code> which is an <code>uhd_usrp_handle</code> is defined in <code>radio.rx.uhd.pointerUSRP</code> or <code>radio.tx.uhd.pointerUSRP</code></li><li>Streamer operations require <code>uhd_rx_streamer_handle</code>, which is in our structure <code>radio.rx.uhd.pointerStreamer</code></li><li>Metadata operation uses <code>uhd_rx_metadata_handle</code> (present by deferencing <code>radio.rx.uhd.addressMD[]</code>) and <code>uhd_tx_metadata_handle</code> (present by deferencing <code>radio.tx.uhd.addressMD[]</code>)</li><li><code>chan</code> corresponds to the index of the used channel. Be default (in SISO) it is <code>0</code></li><li>The <code>uhd_tune_request</code> calls are a little tricky and a Ref of the aligned Julia structure <code>uhd_tune_request</code>should be used. An example is given in the Julia function updateCarrierFreq! </li></ul></li></ul><p>For instance, to manually get the Rx gain and set up the gain without using updateGain! </p><pre><code class="nohighlight hljs">    # High level call 
    using UHDBindings
    radio = openUHD(700e6,4e6,50;nbAntennaRx=1,nbAntennaTx=1)
    # Low level call
    import UHDBindings.LibUHD as LibUHD
    res = Ref{Cdouble}(0) # Define a ref to store the result, should be aligned with type in C UHD function. 
    LibUHD.uhd_usrp_get_rx_gain(radio.rx.uhd.pointerUSRP,0,&quot;&quot;,res)
    println(&quot;The gain is $(res[])&quot;) # using res[] to deference the ref and get the value of the gain</code></pre><p>This low level calls can, be useful (and necessary) to define specific radio configurations and handle scenarios not supported by UHDBindings. This is for example the case of the following example that redefines all the layer to support MIMO. Note that this can be done by initiating <code>openUHD</code> with <code>nbAntennaRx=2</code>.</p><pre><code class="nohighlight hljs"># ----------------------------------------------------
# --- Load packages
# ---------------------------------------------------- 
using UHDBindings 
import UHDBindings.LibUHD as LibUHD
import UHDBindings.initRxUHD
import UHDBindings.@assert_uhd

# ----------------------------------------------------
# --- Parameters 
# ---------------------------------------------------- 
carrierFreq = 868e6
samplingRate= 2e6
gain        = 25
uhdArgs     = &quot;&quot;
nbAntennaRx = 2

# ---------------------------------------------------- 
# --- Create radio 
# ---------------------------------------------------- 
# --- Open radio, in MIMO mode 
# Note the warning about the streamer. It can not be set in MIMO mode 
# The configuration will be updated later, and most of the parameters overwritten
# To ensure we have what we want, we need to bypass the streamer, and deactivate all antennas
radio = openUHD(carrierFreq,samplingRate,gain;nbAntennaRx=0,nbAntennaTx=0,bypassStreamer = true)

# ----------------------------------------------------
# --- Set up Radio 
# ---------------------------------------------------- 
# --- Channels  &amp; Antenna 
channelIndexes = [0,1]
antennas       = [&quot;TX/RX&quot;,&quot;RX2&quot;]
# --- Streamer arguments
a1			   =  Base.unsafe_convert(Cstring,&quot;fc32&quot;);
a2			   =  Base.unsafe_convert(Cstring,&quot;sc16&quot;);
a3			   =  Base.unsafe_convert(Cstring,uhdArgs);
channel        = pointer(channelIndexes)
uhdArgs_0	   = LibUHD.uhd_stream_args_t(a1,a2,a3,channel,nbAntennaRx);
# --- RF Configuration 
for (c,currChan) in enumerate(channelIndexes[1:nbAntennaRx])
    # Set the carrier frequencies 
    updateCarrierFreq!(radio.rx,carrierFreq,currChan)
    # Set the sampling rate 
    updateSamplingRate!(radio.rx,samplingRate,currChan)
    # Set the gains 
    updateGain!(radio.rx,gain,currChan)
    # Set the antennas
    LibUHD.uhd_usrp_set_rx_antenna(radio.rx.uhd.pointerUSRP,antennas[c],currChan)
end
# --- Subdev with 2 boards
pointerSubDev = Ref{LibUHD.uhd_subdev_spec_handle}()
@assert_uhd LibUHD.uhd_subdev_spec_make(pointerSubDev,&quot;A:0 A:1&quot;)
@assert_uhd LibUHD.uhd_usrp_set_rx_subdev_spec(radio.rx.uhd.pointerUSRP,pointerSubDev[],0)
LibUHD.uhd_subdev_spec_free(pointerSubDev)
# --- Internal streamer and buffer config
pointerArgs	  = Ref{LibUHD.uhd_stream_args_t}(uhdArgs_0);
pointerSamples = Ref{Csize_t}(0);
@assert_uhd LibUHD.uhd_usrp_get_rx_stream(radio.rx.uhd.pointerUSRP,pointerArgs,radio.rx.uhd.pointerStreamer)
@assert_uhd LibUHD.uhd_rx_streamer_max_num_samps(radio.rx.uhd.pointerStreamer,pointerSamples)
println(&quot;Internal buffer size is $(pointerSamples[])&quot;)
radio.rx.packetSize= pointerSamples[]
# --- Clock source 
@assert_uhd LibUHD.uhd_usrp_set_clock_source(radio.rx.uhd.pointerUSRP,&quot;internal&quot;,0)
@assert_uhd LibUHD.uhd_usrp_set_time_now(radio.rx.uhd.pointerUSRP,0,0,0)

# ----------------------------------------------------
# --- Set up streamer 
# ---------------------------------------------------- 
streamCmd	= UHDBindings.uhd_stream_cmd_t(UHDBindings.UHD_STREAM_MODE_NUM_SAMPS_AND_MORE,radio.rx.packetSize*10_000,false,1,0.5);
pointerCmd	= Ref{UHDBindings.uhd_stream_cmd_t}(streamCmd);
LibUHD.uhd_rx_streamer_issue_stream_cmd(radio.rx.uhd.pointerStreamer,pointerCmd)
sleep(0.1)
# ---------------------------------------------------- 
# --- Julia buffers 
# ---------------------------------------------------- 	
# Define an array to get all the buffers from all the channels 
nbSamples             = getBufferSize(radio)
sig                   = [zeros(Complex{Cfloat},radio.rx.packetSize) for n ∈ 1:nbAntennaRx]
listBuffer            = [pointer(sig[n],1) for n ∈ 1 : nbAntennaRx]
ptr                   = listBuffer
pointerCounterSamples = Ref{Csize_t}(0);

# ----------------------------------------------------
# --- Receive data 
# ---------------------------------------------------- 
pointerCounterSamples = Ref{Csize_t}(0);
LibUHD.uhd_rx_streamer_recv(radio.rx.uhd.pointerStreamer,ptr,nbSamples,radio.rx.uhd.addressMD,1.6,true,pointerCounterSamples)
nbReceivedSamples = pointerCounterSamples[]
println(&quot;Receive $nbReceivedSamples samples&quot;)

# ----------------------------------------------------
# --- Second call 
# ---------------------------------------------------- 
accum = 0
for iN = 1 : 1 : 10_000
    pointerCounterSamples = Ref{Csize_t}(0);
    LibUHD.uhd_rx_streamer_recv(radio.rx.uhd.pointerStreamer,ptr,nbSamples,radio.rx.uhd.addressMD,0,true,pointerCounterSamples)
    nbReceivedSamples = pointerCounterSamples[]
    global accum += nbReceivedSamples
end
println(&quot;End of transmission, received $accum samples&quot;)
# ----------------------------------------------------
# --- Close 
# ---------------------------------------------------- 
close(radio)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Examples/example_benchmark/">« Benchmark for Rx link</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.19 on <span class="colophon-date" title="Thursday 9 June 2022 13:48">Thursday 9 June 2022</span>. Using Julia version 1.6.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
